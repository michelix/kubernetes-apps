name: Configure and Deploy Homepage Application

on:
  push:
    branches:
      - main
    paths:
      - 'applications/homepage/manifests/**'
      - 'applications/homepage/application.yaml'
      - '.github/workflows/homepage-configure-deploy.yml'
  workflow_dispatch:

jobs:
  configure-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.DOMAIN }}" ]; then
            echo " Error: DOMAIN secret is not set"
            echo "Please set DOMAIN in repository secrets (e.g., 'example.com')"
            exit 1
          fi
          
          if [ -z "${{ secrets.REPO_USERNAME }}" ]; then
            echo " Error: REPO_USERNAME secret is not set"
            echo "Please set REPO_USERNAME in repository secrets (your GitHub username)"
            exit 1
          fi
          
          echo " Required secrets validated"
          echo "Domain: ${{ secrets.DOMAIN }}"
          echo "GitHub Username: ${{ secrets.REPO_USERNAME }}"

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Setup deploy branch
        run: |
          # Check if deploy branch exists remotely
          if git ls-remote --heads origin deploy | grep -q deploy; then
            echo "Deploy branch exists, checking it out"
            git fetch origin deploy
            git checkout deploy
            # Merge latest from main to keep deploy branch updated
            # Use --strategy-option=theirs to prefer main's version in case of conflicts
            if ! git merge main --no-edit --no-ff -X theirs 2>&1; then
              echo "  Merge had conflicts or issues, but continuing..."
              # Check if we're in a conflicted state
              if [ -n "$(git ls-files -u)" ]; then
                echo "Resolving conflicts by preferring main branch..."
                git checkout --theirs .
                git add -A
                git commit -m "chore(homepage): merge main into deploy (conflicts resolved)"
              fi
            else
              echo " Successfully merged main into deploy"
            fi
          else
            echo "Creating new deploy branch from main"
            git checkout -b deploy
          fi

      - name: Configure homepage manifests
        run: |
          DOMAIN="${{ secrets.DOMAIN }}"
          LOCATION="${{ secrets.LOCATION }}"
          LATITUDE="${{ secrets.LATITUDE }}"
          LONGITUDE="${{ secrets.LONGITUDE }}"
          TIMEZONE="${{ secrets.TIMEZONE }}"
          REPO_USERNAME="${{ secrets.REPO_USERNAME }}"
          
          # Set defaults for optional values
          LOCATION="${LOCATION:-Your City}"
          LATITUDE="${LATITUDE:-0.0}"
          LONGITUDE="${LONGITUDE:-0.0}"
          TIMEZONE="${TIMEZONE:-Europe/Berlin}"
          
          echo " Configuring homepage manifests..."
          echo "Domain: ${DOMAIN}"
          echo "Location: ${LOCATION}"
          echo "Coordinates: ${LATITUDE}, ${LONGITUDE}"
          echo "Timezone: ${TIMEZONE}"
          
          # Update homepage configmap
          sed -i "s|YOUR_DOMAIN|${DOMAIN}|g" applications/homepage/manifests/configmap.yaml
          sed -i "s|YOUR_LOCATION|${LOCATION}|g" applications/homepage/manifests/configmap.yaml
          sed -i "s|YOUR_LATITUDE|${LATITUDE}|g" applications/homepage/manifests/configmap.yaml
          sed -i "s|YOUR_LONGITUDE|${LONGITUDE}|g" applications/homepage/manifests/configmap.yaml
          sed -i "s|YOUR_TIMEZONE|${TIMEZONE}|g" applications/homepage/manifests/configmap.yaml
          
          # Update homepage deployment
          sed -i "s|homepage.YOUR_DOMAIN|homepage.${DOMAIN}|g" applications/homepage/manifests/deployment.yaml
          
          # Update homepage ingress
          sed -i "s|YOUR_DOMAIN|${DOMAIN}|g" applications/homepage/manifests/ingress.yaml
          
          # Update homepage application.yaml
          sed -i "s|YOUR_USERNAME|${REPO_USERNAME}|g" applications/homepage/application.yaml
          
          echo " Configuration applied successfully"

      - name: Check for changes
        id: check-changes
        run: |
          # Stage all changes (including merge from main and configuration updates)
          git add -A
          if git diff --staged --quiet && git diff --quiet; then
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
            echo "  No changes detected"
          else
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
            echo "üìù Changes detected (merge from main and/or configuration updates)"
            git status
          fi

      - name: Commit and push changes to deploy branch
        if: steps.check-changes.outputs.HAS_CHANGES == 'true'
        run: |
          # Check if we have uncommitted changes (merge might have already created a commit)
          if ! git diff --quiet || ! git diff --cached --quiet; then
            # We have uncommitted changes, commit them
            git commit -m "chore(homepage): sync from main and configure with domain ${{ secrets.DOMAIN }}"
          fi
          # Push all commits (including merge commit if it was created)
          git push origin deploy

      - name: Output deployment info
        run: |
          echo " Homepage manifests configured and pushed to deploy branch"
          echo "Domain: ${{ secrets.DOMAIN }}"
          echo " ArgoCD will automatically sync the changes from deploy branch"

